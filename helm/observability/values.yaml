# Default values for observability stack

# Global settings
global:
  storageClass: standard

# Prometheus configuration
prometheus:
  enabled: true
  server:
    retention: 15d
    retentionSize: 10GB
    resources:
      limits:
        memory: 2Gi
        cpu: 1000m
      requests:
        memory: 512Mi
        cpu: 250m
    persistentVolume:
      enabled: true
      size: 10Gi
    service:
      type: ClusterIP
    ingress:
      enabled: true
      ingressClassName: nginx
      hosts:
        - prometheus.localhost
  alertmanager:
    enabled: true
    persistence:
      enabled: true
      size: 5Gi
    config:
      global:
        smtp_smarthost: 'localhost:587'
        smtp_from: 'alerts@example.com'
      route:
        receiver: 'default'
        routes:
          - match:
              severity: critical
            receiver: 'critical-alerts'
          - match:
              severity: warning
            receiver: 'warning-alerts'
      receivers:
        - name: 'default'
          slack_configs:
            - api_url: '${SLACK_WEBHOOK_URL}'
              channel: '#alerts'
        - name: 'critical-alerts'
          pagerduty_configs:
            - service_key: '${PAGERDUTY_KEY}'
  extraScrapeConfigs: |
    # Scrape store-platform API metrics
    - job_name: 'store-platform-api'
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - store-platform
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
          action: keep
          regex: api
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          target_label: __address__
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
    
    # Scrape store metrics
    - job_name: 'store-wordpress'
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [__meta_kubernetes_namespace]
          action: keep
          regex: store-.*
        - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
          action: keep
          regex: wordpress

# Grafana configuration
grafana:
  enabled: true
  admin:
    existingSecret: grafana-credentials
    userKey: admin-user
    passwordKey: admin-password
  persistence:
    enabled: true
    size: 5Gi
  resources:
    limits:
      memory: 512Mi
      cpu: 500m
    requests:
      memory: 128Mi
      cpu: 100m
  service:
    type: ClusterIP
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - grafana.localhost
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://observability-prometheus-server
          access: proxy
          isDefault: true
        - name: Loki
          type: loki
          url: http://observability-loki:3100
          access: proxy
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  dashboards:
    default:
      platform-overview:
        url: https://raw.githubusercontent.com/grafana/dashboards/master/dashboards/platform-overview.json
      store-metrics:
        url: https://raw.githubusercontent.com/grafana/dashboards/master/dashboards/store-metrics.json
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
      node-exporter:
        gnetId: 1860
        revision: 27

# Loki configuration
loki:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
  resources:
    limits:
      memory: 1Gi
      cpu: 500m
    requests:
      memory: 256Mi
      cpu: 100m
  config:
    limits_config:
      retention_period: 168h  # 7 days

# Promtail configuration
promtail:
  enabled: true
  config:
    clients:
      - url: http://observability-loki:3100/loki/api/v1/push
    snippets:
      pipelineStages:
        - docker: {}
        - regex:
            expression: 'level=(?P<level>\w+)'
        - labels:
            level:
    scrapeConfigs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_controller_name
            regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
            target_label: __tmp_controller_name
          - source_labels:
              - __meta_kubernetes_pod_label_app_kubernetes_io_name
              - __meta_kubernetes_pod_label_app
              - __tmp_controller_name
              - __meta_kubernetes_pod_name
            regex: ^;*([^;]+)(;.*)?$
            target_label: app
          - source_labels:
              - __meta_kubernetes_pod_label_app_kubernetes_io_instance
              - __meta_kubernetes_pod_label_instance
            target_label: instance
          - source_labels:
              - __meta_kubernetes_pod_label_app_kubernetes_io_component
              - __meta_kubernetes_pod_label_component
            target_label: component
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node_name
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            replacement: $1
            separator: /
            source_labels:
              - namespace
              - app
            target_label: job
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - action: replace
            replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__
